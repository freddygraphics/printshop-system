// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// CLIENT
//
model Client {
  id        Int      @id @default(autoincrement())
  name      String
  company   String?
  email     String?  
  phone     String?
  address   String?
  city      String?
  state     String?
  country   String?
  zip       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quotes   Quote[]
  invoices Invoice[]
  orders   Order[]
  notes    Note[]
}

//
model Product {
  id          Int     @id @default(autoincrement())
  name        String
  sku         String? @unique
  description String?
  category    String?
  basePrice   Float   @default(0)

  defaultOptions Json?
  customFields   Json?

  templateType String? // ‚Üê DEBE ESTAR ESTO
  templateId   Int?
  template     Template? @relation(fields: [templateId], references: [id])

  price Float? @default(0)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  quoteItems   QuoteItem[]
  invoiceItems InvoiceItem[]
  orders       Order[]
}

//
model Quote {
  id            Int       @id @default(autoincrement())
  quoteNumber   Int?      @unique 
  clientId      Int
  quoteDate     DateTime  @default(now())
  validUntil    DateTime?
  subtotal      Float     @default(0)
  tax           Float     @default(0)
  total         Float     @default(0)
  paymentOption String    @default("full")
  status        String    @default("Pending")
  notes         String?
  reference     String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  internalNotes String?
  customerNotes String?

  // Relations
  client   Client      @relation(fields: [clientId], references: [id])
  items    QuoteItem[]
  invoices Invoice[]
   jobs        Job[]   // üëà relaci√≥n
}
model Counter {
  name  String @id
  value Int
}


model QuoteItem {
  id        Int    @id @default(autoincrement())
  quoteId   Int
  productId Int?
  name      String
  qty       Int
  unitPrice Float
  total     Float

  options Json?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quote   Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
}

//
// INVOICES
//
model Invoice {
  id            Int       @id @default(autoincrement())
  clientId      Int
  quoteId       Int?
  invoiceNumber String?   @unique
  subtotal      Float     @default(0)
  tax           Float?    @default(0)
  discount      Float?    @default(0)
  total         Float
  balance       Float?    @default(0)
  paymentStatus String    @default("Unpaid")
  paymentMethod String?
  paymentLink   String?
  issuedAt      DateTime  @default(now())
  dueDate       DateTime?
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client       Client        @relation(fields: [clientId], references: [id])
  quote        Quote?        @relation(fields: [quoteId], references: [id])
  invoiceItems InvoiceItem[]
  orders       Order[]
}

model InvoiceItem {
  id        Int  @id @default(autoincrement())
  invoiceId Int
  productId Int?

  name      String
  qty       Int
  unitPrice Float
  total     Float

  options Json?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
}

//
// ORDERS / PRODUCTION
//
model Order {
  id Int @id @default(autoincrement())

  // üî• tenantId sin relaci√≥n porque Tenant no existe
  tenantId Int?

  productId Int?
  clientId  Int?
  invoiceId Int?

  status String @default("Design")

  workflow     Json?
  customFields Json?

  priority   String? @default("Normal")
  assignedTo String?
  notes      String?

  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones corregidas
  product Product? @relation(fields: [productId], references: [id])
  client  Client?  @relation(fields: [clientId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])
}

//
// NOTES
//
model Note {
  id        Int      @id @default(autoincrement())
  clientId  Int
  client    Client   @relation(fields: [clientId], references: [id])
  type      String   @default("note")
  content   String
  createdAt DateTime @default(now())
  createdBy String?
}

model Template {
  id      Int     @id @default(autoincrement())
  name    String
  type    String? // Ej: "commercial-printing"
  fields  Json? // Aqu√≠ van los customFields del template
  options Json? // Aqu√≠ van las defaultOptions del template

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Job {
  id            Int      @id @default(autoincrement())
  jobNumber     Int      @unique
  quoteId       Int
  status        String   @default("Design")
  dueDate       DateTime?
  notes         String?

  // Team
  salesRepId        Int?
  productionManagerId Int?
  projectManagerId   Int?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  quote       Quote      @relation(fields: [quoteId], references: [id])
  items       JobItem[]
}

model JobItem {
  id        Int    @id @default(autoincrement())
  jobId     Int

  name      String
  qty       Int
  unitPrice Float
  total     Float

  job       Job    @relation(fields: [jobId], references: [id])
}
